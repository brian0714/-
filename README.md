# Taiwan50_stock_predicting_system
使用程式需知：

方案一、

請解壓縮程式zip檔

請在有tensorflow、matplotlib、requests等套件環境下執行，請安裝install.txt所有套件

請執行stock.py以進入主畫面

方案二、

Step1:

在命令列輸入 git clone https://github.com/brian0714/Taiwan50_stock_predicting_system.git

先確保有python

並輸入pip install virtualenv以安裝虛擬環境套件

安裝好後輸入python –m venv “虛擬環境位置”

Step2:

虛擬環境架好後，先啟動虛擬環境

如果是Windows 需要去放置虛擬環境的資料夾找到Script資料夾

裡面有Activate.ps1及activate.bat，看你的終端機是powershell或是cmd去使用

在終端機執行者兩個腳本虛擬環境就啟動了

Step3:

啟動完虛擬環境後接下來要安裝套件

cd到git clone下來的資料夾內

並輸入pip install –r install.txt

Python 會自動抓取所需套件

Step4:

抓取完後就可以啟動程式了，在啟動虛擬環境的狀況下cd到clone下來的資料夾內，然後鍵入python Stock.py

注意要在有網路的環境(因為需要進行爬蟲)

注意：第一次進入系統請等待3-4分鐘使系統能進行爬蟲及更新深度學習模型權重

  

<br>製作本專案步驟：    </br>
Step1: 資料蒐集

利用證券網（網址：https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=html&date={}&stockNo={}）進行爬蟲，以股號及日期來取得台灣50裡各股（共五十支股票）近10年或從上市櫃開始算起迄今日的每日交易資料（日k），其中包括日期、成交股數、成交金額、開盤價、最高價、最低價、收盤價、帳跌價差及成交筆數，最後將各股資料爬取後儲存成csv檔案並後續以python pandas dataframe格式提取資料以便做資料清洗與模型訓練。

Step2: 資料處理

股票資料皆屬於數值型資料。觀察日期資料與其他數值型資料關聯性較低，將其捨去。將資料中的異常符號做刪除，包括"--"及"X0.00"，其符號代表意義為休市、未交易日期及價差帳跌不比價。最終，以K線資料（最高價、最低價、開盤價、收盤價）計算其他技術指標來增加影響價格預測的變數。

Step3: 建立模型

本研究將0050內各成份股，共50支股票各自
建立獨立模型，同時使用相同資料清洗、正規化過程及模型參數。其中，考慮時間序列特徵權重會隨著時間遞減，早期資料對於近期資料的相關性會較低，且因部分成份股資料上市櫃時間不到五年，因此本研究僅採用884天(約三年的交易日)做為訓練及測試資料，其時間序列區間為2018/5/5至2021/12/23。

步驟一、 將資料清洗後的數值資料做獨立的最小值最大值正規化(Min-Max Normalization)

步驟二、 考慮指標變數KDJ、RSI及MACD在計算上會有首日預設的問題以及當資料數涉及天數小於MA預設週期時會使計算結果非平均值，導致前幾日指標並非直接影響價格；因此為避免後續模型訓練提取預設值，本研究在時間推算上會刪減300筆資料。

步驟三、 建立移動式窗口(time_frame)表示LSTM模型中的時間區間，將所有資料以每一個time_frame單位建立成訓練資料，並以該time_frame隔天收盤價做為測試資料且依照時間序列不斷遞移time_frame。本研究因考量資料越線為20天將time_frame單位大小定義為20天。

步驟四、 在LSTM模型參數設定上，考慮現有文獻並無最佳統一參數來選擇神經元數量及神經層數量，因此本研究參照Davies研究所提出之試誤法(Trial and Error)重複試驗找出最佳參數及層數，並以Keras類神經網路架構實作LSTM層數。

本研究原本以傳統預測時間序列方法做時間前後的訓練資料測試資料切分，採用總資料(884天)的前80%作為訓練資料(707筆資料)，總資料的後20%作為測試資料(177筆資料)。然而，在部分成份股中，若後20%測試資料中出現該股歷史中最高價或最低價，則可能會出現低方差(low variance)的問題，因為在訓練過程中無法訊練到該數值。以圖3為例，左圖為隨機訓練一支成份股，並使用10年資料之收盤價變化，以前8年為訓練資料，後2年為測試資料。

因此，本研究為了避免上述問題出現，採以一次僅使用一個time_frame做為訓練資料，並順推下一個time_frame為測試資料，並在本次訓練測試完成後儲存本次模型權重；接著遞移下一次訓練，將上一次測試資料搭配正確收盤價改為訓練資料，同樣將測試資料順推下一個time_frame並在訓練測試後更新模型權重，以此類推完成所有資料的訓練測試。
	透過上述方式可完全解決原本訓練不足的問題，然而在前期訓練的時候會因為訓練資料筆數較少及訓練次數較少而導致模型前期的權重及績效較差，因此在後續計算績效上，我們僅採用一年的交易日來判斷績效。

Step4: 交易策略

本研究將交易成本及交易天數皆考慮進投資策略中，因此此策略會以最保守來計算獲利。其中交易成本包括：

(1)	買賣手續費，為本金之0.1425%

(2)	賣股之交易稅，為本金之0.3%

(3)	證券商提供折扣，可平均預估為本金之0.5%

在交易成本加總後，保守預估為本金之1%。接下來做以下判斷：

1.	判斷交易與否：於隔日9點開市取得開盤價並與預測之收盤價比較利差，若大於門檻值則交易，反之則不交易。
2.	交易：若此利差為正，則需要做多，反之則做空，因此本交易系統在計算獲利上，是以類似當沖形式進行。此外，為了保障策略保守，每日在交易時，若當天價格變動至預測之收盤價時，則必須做出買賣並停止該日交易；若當天價格高估或低估導致直至收盤仍沒有達到預測之收盤價，則在收盤時直接買賣計算獲利，但若該日收盤價與該日開盤價實際利差與預估利差正負相反，則選擇持有股票，表示本日無買賣，不計算獲利。
